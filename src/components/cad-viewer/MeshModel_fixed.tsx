<FULL UPDATED CODE FROM PREVIOUS MESSAGE>